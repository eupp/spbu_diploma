\pagebreak

\section{Симуляция обхода графа \IMM}
\label{sec:simulation}

В данном разделе приводится более подробный обзор
процесса симуляции построения структуры событий по обходу \IMM графа.
В разделе \ref{sec:imm-trav} детально рассматривается
операционная семантика обхода графа \IMM.
В разделе \ref{sec:simrel} описывается
отноешние симуляции $\simrel$.
Наконец, в разделе \ref{sec:simstep} на примере
графа, изображенного на \cref{fig:lb-sim-ex},
рассматривается процесс симуляции шага обхода \IMM графа
семантикой построения структуры событий. 

\input{fig/lb-sim-ex}

\subsection{Обход графа \IMM}
\label{sec:imm-trav}

Определение обхода графа \IMM. Основные инварианты обхода.

\subsection{Отношение симуляции}
\label{sec:simrel}

Далее опишем отношение симуляции $\simrel$.
В целях ясности и простоты изложения, 
в данном разделе будет приведена упрощенная версия формального
определения этого отношения, которая опускает некоторые
технические детали. Полная версия отношения симуляции
может быть найдена в \coq репозитории. 

Отношение симуляции $\simrel(P, T, G, TC, S, X)$
устанавливает взаимосвязь между структурой событий $S$
и графом сценария исполнения $G$ с помощью
функции $\ea : S.\lE \fun G.\lE$, которая отображает
события структуры $S$ в события графа $G$.
Эта функция может быть натуральным образом
расширена на множества событий следующим образом%
\footnote{аналогично образом функций $\ea$ может быть расширена
на бинарные отношения на событиях.}:

\begin{align*}
\text{for } A_S \subseteq S.\lE        & :
  \fmap{A_S} \defeq \set{\ea(e) \in G.\lE \mid e \in A_S} \\
\text{for } A_G \subseteq G.\lE        & :
  \fcomap{A_G} \defeq \set{e \in S.\lE \mid \ea(e) \in A_G}.
\end{align*}

Отношение симуляции $\simrel(P, T, G, \TC, S, X)$ состоит из следующих свойств.

\begin{enumerate}

  \item \label{simrel:events}
    События $S$, принадлежащие потокам из $T$, а также события,
    принадлежащие конфигурации $X$, соответствуют покрытым событиям,
    а также выпущенным событиям и их $\lPO$-предшественникам: 
    \begin{itemize}
      \item $\fmap{S.\lE\rst{T}} = \fmap{X} = C \cup \dom{G.\lPO^? \seq [I]}$
    \end{itemize}

  \item \label{simrel:lab}
    Метки событий из $S$ совпадают с метками событий из $G$
    по модулю прочитанных или записанных значений. 
    \begin{enumerate}
      \setcounter{enumii}{0}
      \item \label{simrel:lab-eqmval}
        $\forall e \in S.\lE \ldotp\;
          S.\set{\lTID, \lTYP, \lLOC, \lMOD}(e) =
          G.\set{\lTID, \lTYP, \lLOC, \lMOD}(\fmap{e}) $
    \end{enumerate}
    Метки покрытых и выпущенных событий, принадлежащих конфигурации $X$,
    сопадают полностью.
    \begin{enumerate}
      \setcounter{enumii}{1}
      \item \label{simrel:lab-det}
        $\forall e \in X \cap \fcomap{C \cup I} \ldotp~
          S.\lVAL(e) = G.\lVAL(\ea(e))$
    \end{enumerate}

  \item \label{simrel:po}
    Программный порядок в структуре событий $S$
    совпадает с программным порядком в графе $G$:
    \begin{itemize}
      \item $\fmap{S.\lPO} \suq G.\lPO$
    \end{itemize}

  \item \label{simrel:cf}
    Если два события имеют одинаковый образ под действием функции $\ea$,
    то эти события равны или находятся в конфликте.
    \begin{itemize}
      \item $\fcomap{\mathtt{id}} \suq S.\lCF^?$
    \end{itemize}

  \item \label{simrel:jf}
    События чтения в $S$ должны быть обоснованы событиями записи,
    которые наблюдаются соответствующим событием чтением в $G$.
    \begin{enumerate}
      \item \label{simrel:jf-obs}
      \setcounter{enumii}{0}
        $\fmap{S.\lJF} \suq G.\lRF^?\seq G.\lHB^?$
    \end{enumerate}
    Более того, отношение $\lJF$, ограниченное на события чтения,
    принадлежащие конфигурации $X$, соответствуют
    отношению \emph{стабильной обоснованности} (\emph{stable justification})
    (смотри \cref{def:sjf}) в графе $G$.
    \begin{enumerate}
      \setcounter{enumii}{1}
      \item \label{simrel:jf-sjf}
        $\fmap{S.\lJF \seq [X]} \suq G.\lSRF_{TC}$
    \end{enumerate}
    %% As a consequence it is possible to derive that
    %% justification for covered events in $X$
    %% corresponds to their justification in $G$:
    %% $\fmap{S.\lJF \seq [X \cap \fcomap{C}]} \subseteq G.\lRF$. \\
    Только выпущенные события могут быть использованы для
    внешнего обоснования событий чтения. 
    \begin{enumerate}
      \setcounter{enumii}{2}
      \item \label{simrel:jfe-iss}
         $\dom{S.\lJFE} \suq \dom{S.\lEW \seq [X \cap \fcomap{I}]}$
    \end{enumerate}

  \item \label{simrel:ew}
    Все эквивалентные события записи в $S$ отображаются
    в одно и то же событие записи $G$.
    \begin{enumerate}
      \setcounter{enumii}{0}
      \item \label{simrel:ew-id}
        $\fmap{S.\lEW} \suq \mathtt{id}$
    \end{enumerate}
    Также каждый класс эквивалентности по отношению $S.\lEW^*$
    должен иметь представителя среди выпущенных событий,
    принадлежащих конфигурации $X$.
    \begin{enumerate}
      \setcounter{enumii}{1}
      \item \label{simrel:ew-iss}
        $S.\lEW \suq (S.\lEW \seq [X \cap \fcomap{I}] \seq S.\lEW)^?$
    \end{enumerate}

  \item \label{simrel:co}
    Если два события структуры $S$ находящихся в отношении когерентности,
    то их образы под действием функции либо также находятся
    в отношении когерентности, либо равны. 
    \begin{enumerate}
      \setcounter{enumii}{0}
      \item \label{simrel:co-co}
         $\fmap{S.\lCO} \suq G.\lCO^?$
    \end{enumerate}
    Если же ребро отношения когерентности оканчивается
    в событии, принадлежащем конфигурации $X$ и одному из потоков из $T$,
    тогда образ этого ребра принадлежит отношению когерентности в графе $G$.
    \begin{enumerate}
      \setcounter{enumii}{1}
      \item \label{simrel:co-cfg}
         $\fmap{S.\lCO \seq [X\rst{T}]} \suq G.\lCO$
    \end{enumerate}

  \item \label{simrel:sw-hb}
    Отношения ``синхронизируется-с'' и ``происходит-до''
    в структуре событий $S$ согласованы с соответствующими
    отношениями в графе $G$.
    \begin{enumerate}
      \item \label{simrel:sw}
        $\fmap{S.\lSW} \suq G.\lSW$
      \item \label{simrel:hb}
        $\fmap{S.\lHB} \suq G.\lHB$
    \end{enumerate}
\end{enumerate}

\input{fig/lb-sim-ex-travA}

В качестве примера, рассмотрим граф $\GTrav$ конфигурацию его обхода $\TC_a$,
и соответствующую этой конфигуарции обхода структуру событий $S_a$,
продемонстрированные на \cref{fig:lb-sim-ex-travA}. 

Покажем, что выполняется 
$\simrel(\progTrav, \lTID(\progTrav), \GTrav, \TC_a, S_a, X_a)$.

Функция $\ea_{\GTrav, S_a}$ задана следующим образом:
$$\ea_{\GTrav,S_a} = \set{
  \Init \mapsto \Init, 
  \ese{1}{1}{1} \mapsto \ese{1}{1}{},
  \ese{1}{2}{1} \mapsto \ese{1}{2}{},
  \ese{1}{3}{1} \mapsto \ese{1}{3}{}
}.$$
Можно видеть, что свойства \ref{simrel:events}, 
\ref{simrel:lab-eqmval}, \ref{simrel:po} отношения симуляции 
действительно выполняются. 
Так как только события $\ese{1}{3}{1}$ и $\ese{1}{3}{}$ должны иметь 
одинаковые метки (поскольку $\ese{1}{3}{}$ является 
единственным выпущенным событием), 
то таким образом свойство \ref{simrel:lab-det} выполняется. 
Поскольку $\lCF=\lEW=\emptyset$, то свойства \ref{simrel:cf} 
и \ref{simrel:ew} также выполняются. 
Свойства \ref{simrel:jf} выполняются, поскольку единственное 
событие чтения $\ese{1}{1}{1}$ обосновано инициализирующей записью $\Init$, 
которая ``происходит-до'' этого события чтения. 
Наконец, можно видеть, что свойства 
\ref{simrel:co} и \ref{simrel:sw-hb} также выполняются. 

\subsection{Шаг симуляции}
\label{sec:simstep}

В данном разделе приводится схема доказательства леммы \ref{lm:simstep}.
А именно, будет показано каким образом
операционная семантика построения структуры событий
симулирует шаг обхода графа \IMM.

Предположим, что для некоторых $P$, $G$, $\TC$, $S$ и $X$
выполняется отношение симуляции $\simrel(P, G, \TC, S, X)$.
Также положим, что в рамках обхода выполняется шаг
$G \vdash \TC \travstep{} \TC'$, который покрывает
или выпускает событие из потока с идентификатором $t$.
По условиям леммы \ref{lm:simstep} требуется предъявить
структуру $S'$ и конфигурацию $X'$,
такие что выполняется $\simrel(P, G, \TC', S', X')$.
Если поток $t$ содержит ещё непокрытые, но уже
выпущенные события записи, то необходимо выполнить
несколько шагов для построения из структуры $S$ структуры $S'$
чтобы добавить все события, $\lPO$-предшествующие непокрытым
событиям записи в потоке $t$.
Будем называть множество этих событий
\emph{сертификационной веткой},
а процесс добавление этих событий --- \emph{сертификацией}.

\input{fig/lb-sim-ex-travB}

Рассмотрим процесс построения сертификационной ветки
на примере шага обхода из конфигурации $\TC_a$ (\cref{fig:lb-sim-ex-travA})
в конфигурацию $\TC_b$ (\cref{fig:lb-sim-ex-travB})
путем выпуска события $\ese{2}{3}{}$.
Чтобы симулировать этот шаг, необходимо выполнить инструкции правого потока
и добавить в структуру событий ветку
$\Br_b = \set{\ese{2}{1}{1},\ese{2}{2}{1},\ese{2}{3}{1}}$
(смотри \cref{fig:lb-sim-ex-travB}).
Для того чтобы добавить эти события, в свою очередь,
выполняется построение трассы операционной семантики потока
${\state \thrdstep{\ese{2}{1}{1}}
         \thrdstep{\ese{2}{2}{1}}
         \thrdstep{\ese{2}{3}{1}}
         \state'}$, 
такой что
(i) она содержит все события правого потока
вплоть до последнего выпущенного события записи $\ese{2}{3}{}$ в графе $G$,
(ii) все эти события должны иметь тот же идентификатор потока,
тип обращения и локацию как и соответствующие события в графе
(то есть $\ese{2}{1}{}, \ese{2}{2}{}, \ese{2}{3}{}$),
(iii) все события, соответствующие покрытым и выпущенным событиям
(в данном случае~$\ese{2}{3}{1}$) должны иметь то же значение,
что и в графе $G$.
Для построения этой трассы используется свойство
\emph{восприимчивости} (\emph{receptiveness})
операционной семантики потока.
Это свойство позволяет выбрать произвольные значения
для всех промежуточных событий чтения в конструируемой трассе,
от которых не зависят (согласно отношению $\lDEPS$) выпущенные события записи%
\footnote{Формальное определение восприимчивости опущено
в данной работе для краткости и может быть найдено в \coq репозитории,
сопровождающем работу~\cite{Podkopaev-al:POPL19}.}.

Помимо этого, при добавлении новой ветки $\Br_b$ в структуру событий
необходимо выполнить следующие требования.
\begin{itemize}
  \item Для каждого события чтения (в данном случае $\ese{2}{1}{1}$ и $\ese{2}{2}{1}$)
    необходимо выбрать событие запись, обосновывающее это чтение.  
  \item Для каждого события записи необходимо определить позицию
    этого события в отношении частичного порядка $\lCO$.
\end{itemize}
Наконец, после завершения процесса сертификации,
новая ветка заменяет собой ветку потока $t$ в конфигурации $X$:
$$ X_b \defeq X_a \setminus S.\lE\rst{t} \cup \Br_b $$
где $S.\lE\rst{t} \defeq \set{e \in S.\lE \sth S.\lTID(e) = t}$.

\paragraph{Обоснование событий чтения.}

Далее рассмотрим процесс выбора обосновывающего события записи
для добавляемого события чтения.
Для этой цели определим отношение \emph{стабильной обоснованности}
в несколько этапов. 

Сначала по графу $G$ и текущей конфигурации обхода $\tup{C, I}$
зададим множество \emph{зафиксированных} (\emph{determined}) событий.
Метки зафиксированных событий а также события записи,
обосновывающие зафиксированные чтения, должны
совпадать в графе $G$, текущей структуре событий $S$,
а также в конструируемой сертификационной ветке $\Br$.

\begin{definition}
\label{def:det}
Множество \emph{зафиксированных событий}
определяется следующим соотношением.
\begin{align*}
  G.D_{\tup{C, I}} &\defeq {}
           C \cup I {}\cup{} \\
     %% &\cup G.\lW \setminus \codom{G.\lPPO} {}\cup{} \\
     &\cup \dom{G.\lRFI^? \seq G.\lPPO \seq [I]} {}\cup{} \\
     &\cup \cod{[I] \seq G.\lRFI} {}\cup{} \\
     &\cup \cod{G.\lRFE \seq [G.\lE^{\squq\acq}]}
\end{align*}
\end{definition}

Помимо покрытых и выпущенных событий
в множество зафиксированных событий также входят
все $\lPPO$-предшественники выпущенных событий,
все события чтения, читающие локально из некоторого выпущенного события,
а также события захватывающего ($\acq$) чтения,
читающие из другого потока. 

Для графа $G$ и конфигурации обхода $\TC_b$,
показанных на \cref{fig:lb-sim-ex-travB},
множество зафиксированных событий 
состоит из событий $\ese{1}{3}{}$, $\ese{2}{2}{}$ и $\ese{2}{3}{}$.
В то же время события $\ese{1}{1}{}$, $\ese{1}{2}{}$ и $\ese{2}{1}{}$
не являются зафиксированными, и следовательно
метки соответствующих им событий в структуре $S_b$
могут отличаться от меток в графе $G$.

Далее, введем понятие \emph{фронта} с помощью отношения $\lVF$.
Множество $\dom{\lVF \seq [e]}$ будем называть \emph{фронтом}
события $e$. Это множество содержит все события записи
``наблюдаемые'' событием $e$.
Будем говорить что $e$ \emph{наблюдает} событие записи $w$,
то есть $\tup{w, e} \in G.\lVF_{\TC}$, если
$w$ ``происходит-до'' $e$, либо оно было
прочитано некоторым покрытым событием, ``происходящим-до''~$e$,
либо оно было ранее прочитано некоторым зафиксированным событием
принадлежащем тому же потококу, что и~$e$. 

\begin{definition}
\label{def:vf}
Отношение $\lVF$ определено как:
\begin{align*}
  G.\lVF_{\tup{C,I}} \defeq {}
    [G.\lW] \seq (G.\lRF \seq [C])^? \seq G.\lHB^? \cup
    G.\lRF \seq [G.D_{\tup{C, I}}] \seq G.\lPO^?.
\end{align*}
\end{definition}

На \cref{fig:lb-sim-ex-travB} изображено три ребра отношения $G.\lVF_{\TC_b}$.
Все остальные ребра этого отношения могут быть выведены
при помощи следующего наблюдения:

$$ {G.\lVF_{\TC} \seq G.\lPO \subseteq G.\lVF_{\TC}}. $$

Наконец, можно привести определение отношения стабильной обоснованости.
Оно соединяет событие чтения с $\lCO$ максимальным
наблюдаемым событием записи в ту же локацию.

\begin{definition}
\label{def:sjf}
Отношение \emph{стабильной обоснованности} определяется следующим образом.
\begin{equation*}
  G.\lSRF_{TC} \defeq
    ([G.\lW] \seq (G.\lVF_{TC} \cap \lEQLOC) \seq [G.\lR])
    \setminus (G.\lCO \seq G.\lVF_{TC})
\end{equation*}
\end{definition}

Для графа $G$ и конфигурации $\TC_b$
отношение $\lSRF$ совпадает c показанными
на \cref{fig:lb-sim-ex-travB} ребрами отношения $\lVF$:
$$\tup{\Init, \ese{1}{1}{}}, \tup{\Init, \ese{2}{1}{}},
  \tup{\ese{1}{3}{}, \ese{2}{2}{}} \in G.\lSRF_{\TC_b}.$$

\begin{lemma}
\label{lm:sjf-det}
Если граф $G$ консистентен согласно модели \IMM,
тогда отношение $G.\lSRF$ совпадает с отношением $G.\lRF$
на множестве зафиксированных событий чтения.
$$  G.\lSRF_{\TC} ; [G.D_{\TC}] \subseteq G.\lRF $$
\end{lemma}

Лемма \ref{lm:sjf-det}, в частности, гарантирует, что
выбранные метки для событий чтения в сертификационной ветке,
от которых зависят (согласно отношению $\lDEPS$) выпущенные события записи,
будут согласованы с метками соответствующих событий в графе $G$.
Для всех остальных событий чтения, согласно свойству восприимчивости,
можно безопасно заменить прочитанные значения.

\begin{lemma}
\label{lm:sjf-iss-po}
Если граф $G$ консистентен согласно модели \IMM,
тогда для отношения $G.\lSRF$ выполняется следующие соотношение:
$$  G.\lSRF_{\TC} \suq [I] \seq G.\lSRF_{\TC} \cup G.\lPO. $$
\end{lemma}

Лемма \ref{lm:sjf-iss-po} позволяет выбрать обосновывающее
событие записи в структуре событий.
Пусть $\tup{w, r} \in G.\lSRF_{\TC}$.
Если при этом $\tup{w, r} \in [I] \seq G.\lSRF_{\TC}$
тогда, согласно свойству \ref{simrel:ew-iss} отношения симуляции
можно выбрать событие записи $w' \in S.\lE$, которое принадлежит
конфигурации $X$ и при этом соответствует выпущенной записи, то есть $\ea(w') = w$.
Например, в случае конфигурации обхода $\TC_b$, показанной на \cref{fig:lb-sim-ex-travB},
для события чтения $\ese{2}{2}{1}$
обосновывающим событием записи будет $\ese{2}{3}{1}$
Иначе $\tup{w, r} \in G.\lPO$.
В таком случае достаточно просто выбрать $S.\lPO$
предшествующее событие записи, принадлежащее сертификационной ветке $\Br$.

\paragraph{Упорядочивание событий записи.}

Позиция добавляемых событий записи в отношении порядка
$S.\lCO$ структуры событий выбирается на основе порядка
$G.\lCO$ \IMM графа. Тем не менее, из-за наличия конфликтующих событий,
можно гарантировать только лишь что отношение $S.\lCO$ вложено
в рефлексивное замыкание отношения $G.\lCO$,
то есть $\fmap{S.\lCO} \subseteq G.\lCO^?$.

\input{fig/lb-sim-ex-travC}

Данную особенность можно продемонстрировать 
на примере шага обхода из конфигурации $\TC_b$ (\cref{fig:lb-sim-ex-travB})
в конфигурацию $\TC_c$ (\cref{fig:lb-sim-ex-travC})
путем покрытия события $\ese{1}{1}{}$.
Для симуляции этого шага выполняется построение
структуры событий $S_c$, содержашей новую ветку 
$\Br_c \defeq \set{\ese{1}{1}{2}, \ese{1}{2}{2}, \ese{1}{3}{2}}$.

Рассмотрим события записи $\ese{1}{2}{1}$ и $\ese{1}{2}{2}$.
Так как два этих события имеют различные метки,
они не могут быть объявлены $\lEW$-эквивалентными.
С другой стороны, требуется, чтобы отношение
$S_c.\lCO$ полностью упорядочивало все события записи в одну и ту же локацию
(по модулю $\lEW$-эквивалентных событий).
То есть требуется каким-либо образом упорядочить
события $\ese{1}{2}{1}$ и $\ese{1}{2}{2}$ между собой.
Так как оба эти события отображаются в одно и то же событие $\ese{1}{2}{}$
в графе $G$, отношение $G.\lCO$ не может быть использовано
при выборе направления $S_c.\lCO$ ребра. 

На самом деле может быть выбран любой из двух способов
упорядочить эти события. Тем не менее,
в целях упрощения доказательства оказалось
удобнее выбрать порядок, при котором новые события
оказываются упорядочены ранее в отношении когеретности.
То есть, возвращаясь к примеру на \cref{fig:lb-sim-ex-travC},
стоит добавить ребро $\tup{\ese{1}{2}{2}, \ese{1}{2}{1}} \in S_c.\lCO$.
Используя данное соглашение можно показать, что
$S.\lCO$ ребро, оканчивающиеся событием из новой ветки $\Br_c$,
должно отображаться строго в ребро $G.\lCO$ в графе: 
$\fmap{S_c.\lCO \seq [\Br_c]} \suq G.\lCO$.

Далее рассмотрим события $\ese{1}{3}{1}$ и $\ese{1}{3}{2}$.
Эти события имеют одинаковую метку и отображаются в одно
и тоже событие $\ese{1}{3}{}$ в графе $G$.
Следовательно, они могут быть объявлены $\lEW$-эквивалентными.
На самом деле, для корректности построения их необходимо объявить таковыми.
Иначе события ветки $\Br_c$ окажутся невидимыми из-за того,
что существует путь $S_c.\lCF \cap (S_c.\lJFE \seq (S_c.\lPO \cup S_c.\lJF)^*)$
из события $\ese{1}{3}{1}$ в событие $\ese{1}{1}{2}$.
Напомним, что только видимые события могут быть использованы
для извлечения графа сценария исполнения из структуры событий
(смотри \cref{def:cfg}).

В общем случае, новое событие записи $e$
прикрепляется к классу эквивалентности по отношению $S.\lEW$,
представленному событием $w$, таким что
(i) $w$ имет тот же образ графе, что и $e$, то есть $\ea(w) = \ea(e)$;
(ii) $w$ принадлежит конфигурации $X$, а его образ в графе
принадлежит множеству выпущенных событий: $w \in X \cap \fcomap{I}$.
Если такого события $w$ не существует, тогда $e$
упорядочивается в отношении $S.\lCO$ до
множества событий, чьи образы в графе $G.\lCO$-предшествуют $\ea(e)$
и после событий, чьи образы в графе равны или $G.\lCO$-следуют за $\ea(e)$.
Благодаря свойству \ref{simrel:jfe-iss} отношения симуляции,
а именно $\dom{S.\lJFE} \suq \dom{S.\lEW \seq [X \cap \fcomap{I}]}$,
подобный выбор отношения $S'.\lEW$ гарантирует,
что все события из новой сертификационной ветки будут видимы. 
